# webpack è¿›é˜¶ç¯‡

## 1. webpack å¦‚ä½•è§£æä»£ç æ¨¡å—è·¯å¾„

åœ¨ webpack æ”¯æŒçš„å‰ç«¯ä»£ç æ¨¡å—åŒ–ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ ES6 çš„æ¨¡å—æ–¹æ³•ï¼Œç±»ä¼¼äº `import * as m from './index.js'` æ¥å¼•ç”¨ä»£ç æ¨¡å— `index.js`ã€‚

å¼•ç”¨ç¬¬ä¸‰æ–¹ç±»åº“åˆ™æ˜¯åƒè¿™æ ·ï¼š`import React from 'react'`ã€‚webpack æ„å»ºçš„æ—¶å€™ï¼Œä¼šè§£æä¾èµ–åï¼Œç„¶åå†å»åŠ è½½ä¾èµ–çš„æ¨¡å—æ–‡ä»¶ã€‚

### 1.1 æ¨¡å—è§£æè§„åˆ™

- è§£æç›¸å¯¹è·¯å¾„

  - æŸ¥æ‰¾ç›¸å¯¹å½“å‰æ¨¡å—çš„è·¯å¾„ä¸‹æ˜¯å¦æœ‰å¯¹åº”æ–‡ä»¶æˆ–æ–‡ä»¶å¤¹
  - æ˜¯æ–‡ä»¶ï¼Œåˆ™ç›´æ¥åŠ è½½
  - æ˜¯æ–‡ä»¶å¤¹ï¼Œåˆ™ç»§ç»­æŸ¥æ‰¾æ–‡ä»¶å¤¹ä¸‹çš„ package.json æ–‡ä»¶
  - æœ‰ package.json æ–‡ä»¶ï¼Œåˆ™æŒ‰ç…§æ–‡ä»¶ä¸­ main å­—æ®µçš„æ–‡ä»¶åæ¥æŸ¥æ‰¾æ–‡ä»¶
  - æ—  package.json æˆ–è€…æ—  main å­—æ®µï¼Œåˆ™æŸ¥æ‰¾ index.js æ–‡ä»¶

- è§£ææ¨¡å—å

  æŸ¥æ‰¾å½“å‰æ–‡ä»¶ç›®å½•ä¸‹ï¼Œçˆ¶çº§ç›®å½•åŠä»¥ä¸Šç›®å½•ä¸‹çš„ `node_modules` æ–‡ä»¶å¤¹ï¼Œçœ‹æ˜¯å¦æœ‰å¯¹åº”åç§°çš„æ¨¡å—

- è§£æç»å¯¹è·¯å¾„ï¼ˆä¸å»ºè®®ä½¿ç”¨ï¼‰

  ç›´æ¥æŸ¥æ‰¾å¯¹åº”è·¯å¾„çš„æ–‡ä»¶

åœ¨ webpack é…ç½®ä¸­ï¼Œå’Œæ¨¡å—è·¯å¾„è§£æç›¸å…³çš„é…ç½®éƒ½åœ¨ `resolve` å­—æ®µä¸‹ï¼š

```js
module.exports = {
  resolve: {
    // ...
  }
};
```

### 1.2 å¸¸ç”¨çš„é…ç½®

æˆ‘ä»¬å…ˆä»ä¸€äº›ç®€å•çš„éœ€æ±‚æ¥é˜è¿° webpack å¯ä»¥æ”¯æŒå“ªäº›è§£æè·¯å¾„è§„åˆ™çš„è‡ªå®šä¹‰é…ç½®ã€‚

#### 1. resolve.alias æŒ‡å®šåˆ«å

å‡è®¾æˆ‘ä»¬æœ‰ä¸ª `utils` æ¨¡å—æå…¶å¸¸ç”¨ï¼Œç»å¸¸ç¼–å†™ç›¸å¯¹è·¯å¾„å¾ˆéº»çƒ¦ï¼Œå¸Œæœ›å¯ä»¥ç›´æ¥ `import 'utils'` æ¥å¼•ç”¨ï¼Œé‚£ä¹ˆæˆ‘ä»¬å¯ä»¥é…ç½®æŸä¸ªæ¨¡å—çš„åˆ«åï¼Œå¦‚ï¼š

```js
module.exports = {
  resolve: {
    alias: {
      // è¿™é‡Œä½¿ç”¨ path.resolve å’Œ **dirname æ¥è·å–ç»å¯¹è·¯å¾„
      utils: path.resolve(**dirname, 'src/utils')
    }
  }
};
```

ä¸Šè¿°çš„é…ç½®æ˜¯æ¨¡ç³ŠåŒ¹é…ï¼Œæ„å‘³ç€åªè¦æ¨¡å—è·¯å¾„ä¸­æºå¸¦äº† utils å°±å¯ä»¥è¢«æ›¿æ¢æ‰ï¼Œå¦‚ï¼š

```js
import "utils/query.js"; // ç­‰åŒäº import '[é¡¹ç›®ç»å¯¹è·¯å¾„]/src/utils/query.js'
```

å¦‚æœéœ€è¦è¿›è¡Œ`ç²¾ç¡®åŒ¹é…`å¯ä»¥ä½¿ç”¨ï¼š

```js
module.exports = {
  resolve: {
    alias: {
      // åªä¼šåŒ¹é… import 'utils'
      utils$: path.resolve(__dirname, "src/utils")
    }
  }
};
```

#### 2.resolve.extensions æŒ‡å®šæ–‡ä»¶åç¼€å

åœ¨çœ‹ç¬¬ 1 å°èŠ‚ä¸­çš„ webpack é…ç½®æ—¶ï¼Œä½ å¯èƒ½ç•™æ„åˆ°äº†è¿™ä¹ˆä¸€è¡Œï¼š

```js
module.exports = {
  resolve: {
    alias: {
      // åªä¼šåŒ¹é… import 'utils'
      utils$: path.resolve(__dirname, "src/utils")
    },
    extensions: [".wasm", ".mjs", ".js", ".json", ".jsx"]
    // è¿™é‡Œçš„é¡ºåºä»£è¡¨åŒ¹é…åç¼€çš„ä¼˜å…ˆçº§ï¼Œä¾‹å¦‚å¯¹äº index.js å’Œ index.jsxï¼Œä¼šä¼˜å…ˆé€‰æ‹© index.js
  }
};
```

è¿™ä¸ªé…ç½®å¯ä»¥å®šä¹‰åœ¨è¿›è¡Œæ¨¡å—è·¯å¾„è§£ææ—¶ï¼Œwebpack ä¼šå°è¯•å¸®ä½ è¡¥å…¨é‚£äº›åç¼€åæ¥è¿›è¡ŒæŸ¥æ‰¾ã€‚ä¾‹å¦‚æœ‰äº†ä¸Šè¿°çš„é…ç½®ï¼Œå½“ä½ åœ¨ `src/utils/` ç›®å½•ä¸‹æœ‰ä¸€ä¸ª `common.js` æ–‡ä»¶æ—¶ï¼Œå°±å¯ä»¥è¿™æ ·æ¥å¼•ç”¨ï¼š

```js
import * as common from "./src/utils/common";
```

ä½†å¦‚æœä½ æ˜¯å¼•ç”¨ `src/styles` ç›®å½•ä¸‹çš„ `common.css` æ–‡ä»¶æ—¶ï¼Œå¦‚ `import './src/styles/common'`ï¼Œwebpack æ„å»ºæ—¶åˆ™ä¼šæŠ¥æ— æ³•è§£ææ¨¡å—çš„é”™è¯¯ã€‚

ä½ å¯ä»¥åœ¨å¼•ç”¨æ—¶æ·»åŠ åç¼€ï¼Œ`import './src/styles/common.css'` æ¥è§£å†³ï¼Œæˆ–è€…åœ¨ `extensions` æ·»åŠ ä¸€ä¸ª `.css` çš„é…ç½®ï¼š

```js
module.exports = {
  resolve: {
    alias: {
      // åªä¼šåŒ¹é… import 'utils'
      utils$: path.resolve(__dirname, "src/utils")
    },
    extensions: [".wasm", ".mjs", ".js", ".json", ".jsx", ".css"]
  }
};
```

#### 3.resolve.modules æŒ‡å®šæ¨¡å—è·¯å¾„

å¯¹äºç›´æ¥å£°æ˜ä¾èµ–åçš„æ¨¡å—ï¼ˆå¦‚ react ï¼‰ï¼Œwebpack ä¼šç±»ä¼¼ Node.js ä¸€æ ·è¿›è¡Œè·¯å¾„æœç´¢ï¼Œæœç´¢ `node_modules` ç›®å½•ï¼Œè¿™ä¸ªç›®å½•å°±æ˜¯ä½¿ç”¨ `resolve.modules` å­—æ®µè¿›è¡Œé…ç½®çš„ï¼Œé»˜è®¤å°±æ˜¯ï¼š

```js
module.exports = {
  resolve: {
    alias: {
      // åªä¼šåŒ¹é… import 'utils'
      utils$: path.resolve(__dirname, "src/utils")
    },
    extensions: [".wasm", ".mjs", ".js", ".json", ".jsx", ".css"],
    modules: ["node_modules"]
  }
};
```

é€šå¸¸æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬ä¸ä¼šè°ƒæ•´è¿™ä¸ªé…ç½®ã€‚ä½†å¦‚æœå¯ä»¥ç¡®å®šé¡¹ç›®å†…æ‰€æœ‰çš„`ç¬¬ä¸‰æ–¹ä¾èµ–æ¨¡å—`éƒ½æ˜¯åœ¨é¡¹ç›®æ ¹ç›®å½•ä¸‹çš„ `node_modules` ä¸­çš„è¯ï¼Œé‚£ä¹ˆå¯ä»¥åœ¨ `node_modules` ä¹‹å‰é…ç½®ä¸€ä¸ªç¡®å®šçš„`ç»å¯¹è·¯å¾„`ï¼š

```js
module.exports = {
  resolve: {
    alias: {
      // åªä¼šåŒ¹é… import 'utils'
      utils$: path.resolve(__dirname, "src/utils")
    },
    extensions: [".wasm", ".mjs", ".js", ".json", ".jsx", ".css"],
    modules: [
      path.resolve(__dirname, "node_modules"), // æŒ‡å®šå½“å‰ç›®å½•ä¸‹çš„ node_modules ä¼˜å…ˆæŸ¥æ‰¾
      "node_modules" // å¦‚æœæœ‰ä¸€äº›ç±»åº“æ˜¯æ”¾åœ¨ä¸€äº›å¥‡æ€ªçš„åœ°æ–¹çš„ï¼Œä½ å¯ä»¥æ·»åŠ è‡ªå®šä¹‰çš„è·¯å¾„æˆ–è€…ç›®å½•
    ]
  }
};
```

è¿™æ ·é…ç½®åœ¨æŸç§ç¨‹åº¦ä¸Šå¯ä»¥ç®€åŒ–æ¨¡å—çš„æŸ¥æ‰¾ï¼Œæå‡æ„å»ºé€Ÿåº¦ã€‚

#### 4.resolve.mainFields

æœ‰ `package.json` æ–‡ä»¶åˆ™æŒ‰ç…§æ–‡ä»¶ä¸­ `main å­—æ®µ`çš„æ–‡ä»¶åæ¥æŸ¥æ‰¾æ–‡ä»¶ã€‚

æˆ‘ä»¬ä¹‹å‰æœ‰æåˆ°è¿™ä¹ˆä¸€å¥è¯ï¼Œå…¶å®ç¡®åˆ‡çš„æƒ…å†µå¹¶ä¸æ˜¯è¿™æ ·çš„ï¼Œwebpack çš„ resolve.mainFields é…ç½®å¯ä»¥è¿›è¡Œè°ƒæ•´ã€‚å½“å¼•ç”¨çš„æ˜¯ä¸€ä¸ªæ¨¡å—æˆ–è€…ä¸€ä¸ªç›®å½•æ—¶ï¼Œä¼šä½¿ç”¨ package.json æ–‡ä»¶çš„å“ªä¸€ä¸ªå­—æ®µä¸‹æŒ‡å®šçš„æ–‡ä»¶ï¼Œé»˜è®¤çš„é…ç½®æ˜¯è¿™æ ·çš„ï¼š

```js
module.exports = {
  resolve: {
    // é…ç½® target === "web" æˆ–è€… target === "webworker" æ—¶ mainFields é»˜è®¤å€¼æ˜¯ï¼š
    mainFields: ["browser", "module", "main"],

    // target çš„å€¼ä¸ºå…¶ä»–æ—¶ï¼ŒmainFields é»˜è®¤å€¼ä¸ºï¼š
    mainFields: ["module", "main"]
  }
};
```

å› ä¸ºé€šå¸¸æƒ…å†µä¸‹ï¼Œæ¨¡å—çš„ package éƒ½ä¸ä¼šå£°æ˜ browser æˆ– module å­—æ®µï¼Œæ‰€ä»¥ä¾¿æ˜¯ä½¿ç”¨ main äº†ã€‚

åœ¨ NPM packages ä¸­ï¼Œä¼šæœ‰äº› package æä¾›äº†ä¸¤ä¸ªå®ç°ï¼Œåˆ†åˆ«ç»™æµè§ˆå™¨å’Œ Node.js ä¸¤ä¸ªä¸åŒçš„è¿è¡Œæ—¶ä½¿ç”¨ï¼Œè¿™ä¸ªæ—¶å€™å°±éœ€è¦åŒºåˆ†ä¸åŒçš„å®ç°å…¥å£åœ¨å“ªé‡Œã€‚

#### 5.resolve.mainFiles

å½“ç›®å½•ä¸‹æ²¡æœ‰ `package.json` æ–‡ä»¶æ—¶ï¼Œæˆ‘ä»¬è¯´ä¼šé»˜è®¤ä½¿ç”¨ç›®å½•ä¸‹çš„ `index.js`è¿™ä¸ªæ–‡ä»¶ï¼Œå…¶å®è¿™ä¸ªä¹Ÿæ˜¯å¯ä»¥ä½¿ç”¨ resolve.mainFiles å­—æ®µé…ç½®çš„ã€‚é»˜è®¤é…ç½®æ˜¯ï¼š

```js
module.exports = {
  resolve: {
    mainFiles: ["index"] // ä½ å¯ä»¥æ·»åŠ å…¶ä»–é»˜è®¤ä½¿ç”¨çš„æ–‡ä»¶å
  }
};
```

é€šå¸¸æƒ…å†µä¸‹æˆ‘ä»¬ä¹Ÿæ— é¡»ä¿®æ”¹è¿™ä¸ªé…ç½®ï¼Œindex.js åŸºæœ¬å°±æ˜¯çº¦å®šä¿—æˆçš„äº†ã€‚

#### 6. resolve.resolveLoader

è¿™ä¸ªå­—æ®µ resolve.resolveLoader ç”¨äºé…ç½®è§£æ loader æ—¶çš„ resolve é…ç½®ï¼ŒåŸæœ¬ resolve çš„é…ç½®é¡¹åœ¨è¿™ä¸ªå­—æ®µä¸‹åŸºæœ¬éƒ½æœ‰ã€‚æˆ‘ä»¬çœ‹ä¸‹é»˜è®¤çš„é…ç½®ï¼š

```js
module.exports = {
  resolve: {
    resolveLoader: {
      extensions: [".js", ".json"],
      mainFields: ["loader", "main"]
    }
  }
};
```

è¿™é‡Œæä¾›çš„é…ç½®ç›¸å¯¹å°‘ç”¨ï¼Œæˆ‘ä»¬ä¸€èˆ¬éµä»æ ‡å‡†çš„ä½¿ç”¨æ–¹å¼ï¼Œä½¿ç”¨é»˜è®¤é…ç½®ï¼Œç„¶åæŠŠ loader å®‰è£…åœ¨é¡¹ç›®æ ¹è·¯å¾„ä¸‹çš„ node_modules ä¸‹å°±å¯ä»¥äº†ã€‚

## 2. loader çš„é…ç½®

webpack çš„ loader ç”¨äºå¤„ç†`ä¸åŒçš„æ–‡ä»¶ç±»å‹`ï¼Œåœ¨æ—¥å¸¸çš„é¡¹ç›®ä¸­ä½¿ç”¨ loader æ—¶ï¼Œå¯èƒ½ä¼šé‡åˆ°æ¯”è¾ƒå¤æ‚çš„æƒ…å†µã€‚

### 2.1 åŒ¹é…è§„åˆ™ module.rules

é…ç½® loader æ—¶ï¼Œåœ¨ `module.rules`å­—æ®µ ä¸­æ·»åŠ æ–°çš„é…ç½®é¡¹ã€‚åœ¨è¯¥å­—æ®µä¸­ï¼Œæ¯ä¸€é¡¹è¢«è§†ä¸ºä¸€æ¡åŒ¹é…ä½¿ç”¨ loader çš„è§„åˆ™ã€‚

```js
module.exports = {
  // ...
  module: {
    rules: [
      {
        test: /\.jsx?/, // æ¡ä»¶
        include: [path.resolve(__dirname, "src")], // æ¡ä»¶
        use: "babel-loader" // è§„åˆ™åº”ç”¨ç»“æœ
      } // ä¸€ä¸ª object å³ä¸€æ¡è§„åˆ™
      // ...
    ]
  }
};
```
